<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Flota - El Manantial</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            beige: '#F3EAD6',
                            green: { dark: '#1B4D3E', light: '#4CAF50', hover: '#143d30' },
                            orange: '#F59E0B', cream: '#FFFDF5'
                        }
                    },
                    fontFamily: { sans: ['Roboto', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #F3EAD6; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex">

    <aside class="w-64 bg-brand-green-dark text-white hidden md:flex flex-col flex-shrink-0 shadow-xl z-20">
        <div class="pt-8 px-6 mb-8">
            <div class="flex items-center space-x-3">
                <div class="bg-white rounded-full p-0.5 shadow-lg flex-shrink-0 overflow-hidden w-12 h-12 relative border-2 border-green-500/20">
                    <img src="/static/logo.png" alt="Logo Semillero" class="w-full h-full object-cover">
                </div>
                <div class="flex flex-col justify-center">
                    <p class="text-brand-orange text-[10px] uppercase tracking-widest font-bold leading-tight">Semillero</p>
                    <h1 class="text-white text-lg font-bold leading-none tracking-tight mt-0.5">
                        El Manantial
                        <span class="text-[9px] font-normal opacity-70 ml-1 align-top">S.R.L</span>
                    </h1>
                </div>
            </div>
        </div>
        
        <nav class="flex-1 px-4 space-y-2 mt-4">
            <button onclick="showDashboard()" id="nav-dashboard" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors bg-brand-green-light text-white font-semibold">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>Dashboard</span>
            </button>
            
            <button onclick="openNewUnitModal()" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-brand-green-hover transition-colors">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                <span>Nueva Unidad</span>
            </button>

            <button onclick="showSettings()" id="nav-settings" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-brand-green-hover transition-colors">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span>Configuración</span>
            </button>
        </nav>

        <div class="p-4 border-t border-brand-green-hover">
            <button onclick="logout()" class="w-full flex items-center space-x-3 px-4 py-3 text-red-300 hover:bg-red-900/20 rounded-lg transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>Cerrar Sesión</span>
            </button>
            <p class="text-center text-xs text-gray-500 mt-4">v2.2 Fix | Admin</p>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative bg-brand-beige">
        
        <div class="md:hidden bg-brand-green-dark p-4 flex justify-between items-center shadow-md sticky top-0 z-10">
           <span class="text-white font-bold text-lg">El Manantial</span>
           <button class="text-white"><i data-lucide="menu" class="w-6 h-6"></i></button>
        </div>

        <div id="view-dashboard" class="p-6 md:p-10 max-w-7xl mx-auto fade-in">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-brand-green-dark flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Total Unidades</p>
                        <h3 id="stat-total" class="text-3xl font-bold text-gray-800">...</h3>
                    </div>
                    <div class="bg-brand-beige p-3 rounded-full">
                        <i data-lucide="truck" class="w-6 h-6 text-brand-green-dark"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-brand-orange flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Atención Requerida</p>
                        <h3 id="stat-attention" class="text-3xl font-bold text-gray-800">...</h3>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-full">
                        <i data-lucide="alert-triangle" class="w-6 h-6 text-brand-orange"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500 flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Operativos OK</p>
                        <h3 id="stat-ok" class="text-3xl font-bold text-gray-800">...</h3>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-brand-green-dark">Estado de Flota</h2>
                <div class="relative w-full md:w-96">
                    <input type="text" id="search-input" placeholder="Buscar por patente o descripción..." class="w-full pl-10 pr-4 py-2 bg-white text-gray-900 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-green-light" oninput="renderTruckGrid()" />
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-5 h-5 text-gray-400"></i>
                </div>
            </div>

            <div id="trucks-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <div class="col-span-full text-center py-10"><p class="text-gray-500 animate-pulse">Cargando datos...</p></div>
            </div>
        </div>

        <div id="view-detail" class="hidden p-6 md:p-10 max-w-6xl mx-auto fade-in">
            <button onclick="showDashboard()" class="flex items-center text-brand-green-dark hover:text-brand-orange mb-6 transition-colors font-medium">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Volver al Dashboard
            </button>

            <div class="flex flex-col lg:flex-row gap-8">
                <div class="lg:w-2/3 space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-brand-cream px-6 py-4 border-b border-brand-beige">
                            <h3 class="font-bold text-lg text-brand-green-dark flex items-center"><i data-lucide="file-text" class="w-5 h-5 mr-2"></i> Datos Principales</h3>
                        </div>
                        <div class="p-6">
                            <form onsubmit="handleGeneralUpdate(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Patente</label><input type="text" id="input-patente" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg uppercase" /></div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label><input type="text" id="input-descripcion" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg" /></div>
                                <div class="md:col-span-2 text-right"><button type="submit" class="bg-brand-green-dark text-white px-4 py-2 rounded-lg text-sm hover:bg-brand-green-hover inline-flex items-center transition-colors ml-auto"><i data-lucide="save" class="w-4 h-4 mr-2"></i> Guardar Cambios</button></div>
                            </form>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border-2 border-brand-green-light/20 overflow-hidden">
                        <div class="bg-brand-green-light text-white px-6 py-4">
                            <h3 class="font-bold text-lg flex items-center"><i data-lucide="wrench" class="w-5 h-5 mr-2"></i> Registrar Service Completo</h3>
                        </div>
                        <div class="p-6">
                            <form onsubmit="handleServiceUpdate(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label><input type="date" id="input-service-fecha" required class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg" /></div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">KM del Service</label><input type="number" id="input-service-km" required placeholder="0" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg" /></div>
                                <div class="md:col-span-2"><button type="submit" class="w-full bg-brand-green-light hover:bg-green-600 text-white font-bold py-2 rounded-lg transition-colors shadow-md">Registrar Service</button></div>
                            </form>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-brand-cream px-6 py-4 border-b border-brand-beige"><h3 class="font-bold text-lg text-brand-green-dark">Historial Reciente</h3></div>
                        <div class="p-0"><ul id="history-list" class="divide-y divide-gray-100"></ul></div>
                    </div>
                </div>

                <div class="lg:w-1/3 space-y-6">
                    <div class="bg-white rounded-xl shadow-md border border-gray-200">
                        <div class="bg-brand-green-dark text-white px-6 py-4 rounded-t-xl"><h3 class="font-bold">Estado Actual</h3></div>
                        <div class="p-6 space-y-6">
                            <div class="space-y-2">
                                <label class="flex justify-between text-sm font-medium text-gray-700"><span>Kilometraje</span><span id="status-km-label" class="font-bold"></span></label>
                                <div class="flex gap-2">
                                    <input type="number" id="input-km-actual" class="flex-1 px-3 py-1 bg-white border border-gray-300 rounded text-sm" />
                                    <button onclick="handleGeneralUpdate(event)" class="bg-gray-100 hover:bg-gray-200 border border-gray-200 px-3 rounded text-gray-600 transition-colors"><i data-lucide="save" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <hr class="border-gray-100" />
                            <div id="vencimientos-container" class="space-y-4"></div>
                            <div id="add-filter-btn" class="mt-4 pt-4 border-t border-gray-100 hidden">
                                <button onclick="addFilterComanry()" class="text-xs text-brand-orange hover:underline font-bold flex items-center"><span class="text-lg mr-1">+</span> Agregar Filtro Comanry</button>
                            </div>
                        </div>
                    </div>
                    <div class="border border-red-200 bg-red-50 rounded-xl p-4 flex justify-between items-center">
                        <span class="text-red-800 text-sm font-medium">Eliminar Unidad</span>
                        <button onclick="deleteTruck()" class="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm transition-colors flex items-center"><i data-lucide="trash-2" class="w-4 h-4 mr-1"></i> Eliminar</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-settings" class="hidden p-6 md:p-10 max-w-3xl mx-auto fade-in">
            <button onclick="showDashboard()" class="flex items-center text-brand-green-dark hover:text-brand-orange mb-6 transition-colors font-medium"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Volver al Dashboard</button>
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                <div class="bg-brand-green-dark text-white px-8 py-6"><h2 class="text-2xl font-bold flex items-center"><i data-lucide="settings" class="w-8 h-8 mr-3 text-brand-orange"></i> Configuración</h2></div>
                <div class="p-8 space-y-8">
                    <div class="grid grid-cols-1 gap-6">
                        <div><label class="block text-sm font-bold text-gray-700 mb-2">Días para aviso</label><input type="number" id="config-dias" value="30" class="w-full md:w-1/2 px-4 py-2 border rounded-lg" /></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-2">Email Alertas</label><input type="email" id="config-email" value="admin@elmanantial.com" class="w-full md:w-2/3 px-4 py-2 border rounded-lg" /></div>
                    </div>
                    <div class="pt-6 border-t border-gray-100 flex justify-end">
                        <button onclick="saveConfig()" class="bg-brand-green-light hover:bg-green-600 text-white px-6 py-3 rounded-lg font-bold shadow-md flex items-center"><i data-lucide="save" class="w-5 h-5 mr-2"></i> Guardar</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-new-unit" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 fade-in">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
                <div class="bg-brand-green-dark px-6 py-4 flex justify-between items-center">
                    <h3 class="text-white font-bold text-lg flex items-center"><i data-lucide="plus-circle" class="w-5 h-5 mr-2 text-brand-orange"></i> Nueva Unidad</h3>
                    <button onclick="closeNewUnitModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <form id="form-new-truck" onsubmit="handleNewUnit(event)" class="p-6 space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Patente</label><input id="new-patente" required type="text" placeholder="Ej: AA 123 BB" class="w-full px-3 py-2 border rounded-lg uppercase" /></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label><input id="new-descripcion" required type="text" placeholder="Ej: Scania P310" class="w-full px-3 py-2 border rounded-lg" /></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Kilometraje</label><input id="new-km" required type="number" placeholder="0" class="w-full px-3 py-2 border rounded-lg" /></div>
                    <div class="pt-4 flex justify-end space-x-3">
                        <button type="button" onclick="closeNewUnitModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-brand-green-light hover:bg-brand-green-hover text-white font-bold rounded-lg shadow">Guardar</button>
                    </div>
                </form>
            </div>
        </div>

    </main>

    <script>
        let FLOTA_DATA = []; 
        let CONFIG = { diasAviso: 30, emailAlertas: 'admin@elmanantial.com' };
        let selectedTruckId = null;
        const API_URL = '/api/flota'; 

        // --- INIT ---
        window.onload = function() {
            lucide.createIcons();
            cargarDatosDelServidor();
        };

        // --- 1. CARGA DE DATOS BLINDADA ---
        async function cargarDatosDelServidor() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("API Error");
                
                let rawData = await response.json();
                
                // NORMALIZACIÓN DE DATOS (Esto repara camiones viejos al vuelo)
                FLOTA_DATA = rawData.map(c => ({
                    ...c,
                    id: parseInt(c.id), // Aseguramos que sea número
                    patente: c.patente || "SIN PATENTE",
                    descripcion: c.descripcion || "Sin descripción",
                    km_actual: c.km_actual || 0,
                    // Si falta service, creamos objeto por defecto
                    service: c.service || { ultimo_fecha: "", ultimo_km: 0, intervalo_km: 10000 },
                    // Aseguramos que vencimientos tenga todas las claves
                    vencimientos: {
                        desinfeccion: c.vencimientos?.desinfeccion || "",
                        seguro: c.vencimientos?.seguro || "",
                        vtv: c.vencimientos?.vtv || "",
                        filtro_comanry: c.vencimientos?.filtro_comanry || ""
                    },
                    historial: c.historial || []
                }));

                renderDashboard();
            } catch (error) {
                console.error("Error cargando datos:", error);
                document.getElementById('trucks-grid').innerHTML = '<div class="col-span-full text-center py-10 text-red-500">Error conectando con el servidor.</div>';
            }
        }

        async function guardarEnServidor() {
            try {
                await fetch('/api/guardar_flota', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(FLOTA_DATA)
                });
                console.log("Guardado exitoso");
                return true;
            } catch (error) {
                alert("Error al guardar en el servidor.");
                return false;
            }
        }

        // --- HELPERS ---
        const formatNumber = (num) => new Intl.NumberFormat('es-AR').format(num || 0);

        const verificarFecha = (f) => {
            if (!f) return { status: 'ERROR', message: 'SIN DATOS' };
            const diff = Math.ceil((new Date(f) - new Date().setHours(0,0,0,0)) / (86400000));
            if (diff < 0) return { status: 'DANGER', message: `VENCIDO (${Math.abs(diff)} d)` };
            if (diff <= CONFIG.diasAviso) return { status: 'WARNING', message: `Vence en ${diff} d` };
            return { status: 'OK', message: 'OK' };
        };

        const verificarService = (c) => {
            const diff = (c.service.ultimo_km + c.service.intervalo_km) - c.km_actual;
            if (diff < 0) return { status: 'DANGER', message: `VENCIDO (${Math.abs(diff)} km)` };
            if (diff <= 2000) return { status: 'WARNING', message: `Faltan ${diff} km` };
            return { status: 'OK', message: 'OK' };
        };

        const getBadgeStyles = (s) => s === 'OK' ? 'bg-green-100 text-green-800' : s === 'DANGER' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
        const getTextClass = (s) => s === 'OK' ? 'text-green-600' : s === 'DANGER' ? 'text-red-600 font-bold' : 'text-yellow-600 font-bold';

        // --- NAVIGATION ---
        function hideAllViews() {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-detail').classList.add('hidden');
            document.getElementById('view-settings').classList.add('hidden');
            ['nav-dashboard', 'nav-settings'].forEach(id => {
                document.getElementById(id).classList.remove('bg-brand-green-light', 'text-white');
                document.getElementById(id).classList.add('text-gray-300');
            });
        }

        function showDashboard() {
            hideAllViews();
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('nav-dashboard').classList.add('bg-brand-green-light', 'text-white');
            renderDashboard();
        }

        function showSettings() {
            hideAllViews();
            document.getElementById('view-settings').classList.remove('hidden');
            document.getElementById('nav-settings').classList.add('bg-brand-green-light', 'text-white');
        }

        function showDetail(id) {
            // Convertimos a int para asegurar coincidencia
            selectedTruckId = parseInt(id);
            hideAllViews();
            document.getElementById('view-detail').classList.remove('hidden');
            renderDetailView();
        }

        function logout() { window.location.href = '/logout'; }

        // --- MODALS ---
        function openNewUnitModal() { 
            document.getElementById('modal-new-unit').classList.remove('hidden'); 
            document.getElementById('form-new-truck').reset();
        }
        function closeNewUnitModal() { document.getElementById('modal-new-unit').classList.add('hidden'); }

        // --- RENDER DASHBOARD ---
        function renderDashboard() {
            const grid = document.getElementById('trucks-grid');
            grid.innerHTML = '';
            const term = document.getElementById('search-input').value.toLowerCase();

            let att = 0;
            FLOTA_DATA.forEach(c => {
                if(verificarService(c).status !== 'OK') att++;
                else if(Object.values(c.vencimientos).some(v => v && verificarFecha(v).status !== 'OK')) att++;
            });
            document.getElementById('stat-total').innerText = FLOTA_DATA.length;
            document.getElementById('stat-attention').innerText = att;
            document.getElementById('stat-ok').innerText = FLOTA_DATA.length - att;

            const filtered = FLOTA_DATA.filter(c => c.patente.toLowerCase().includes(term) || c.descripcion.toLowerCase().includes(term));

            filtered.forEach(c => {
                const sv = verificarService(c);
                let vHtml = '';
                // Mostramos solo los que tienen fecha en el dashboard
                Object.entries(c.vencimientos).forEach(([k,v]) => {
                    if(!v || k === 'filtro_comanry') return;
                    const st = verificarFecha(v);
                    vHtml += `<div class="flex justify-between text-xs"><span class="capitalize text-gray-500">${k}</span><span class="${getTextClass(st.status)}">${st.message}</span></div>`;
                });

                const card = document.createElement('div');
                card.className = "bg-white rounded-xl shadow-md hover:shadow-xl transition-all cursor-pointer border overflow-hidden";
                card.onclick = () => showDetail(c.id);
                card.innerHTML = `
                    <div class="bg-brand-cream p-4 border-b flex justify-between items-center">
                        <div><h3 class="font-bold text-brand-green-dark">${c.patente}</h3><p class="text-xs text-gray-500">${c.descripcion}</p></div>
                        <span class="bg-white text-xs px-2 py-1 rounded border">ID: ${c.id}</span>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex justify-between"><span class="text-sm font-medium">KM</span><span class="font-mono font-bold">${formatNumber(c.km_actual)}</span></div>
                        <div class="flex justify-between"><span class="text-sm font-medium">Service</span><span class="text-xs px-2 py-0.5 rounded ${getBadgeStyles(sv.status)}">${sv.message}</span></div>
                        <div class="border-t pt-2 space-y-1">${vHtml}</div>
                    </div>
                    <div class="bg-gray-50 p-2 text-center text-xs text-brand-green-light font-bold uppercase tracking-wider hover:bg-gray-100">Ver Detalles &rarr;</div>`;
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- RENDER DETAIL ---
        function renderDetailView() {
            const c = FLOTA_DATA.find(x => x.id === selectedTruckId);
            if(!c) return;

            document.getElementById('input-patente').value = c.patente;
            document.getElementById('input-descripcion').value = c.descripcion;
            document.getElementById('input-km-actual').value = c.km_actual;
            document.getElementById('input-service-km').placeholder = `Actual: ${c.km_actual}`;
            
            // Historial
            const hl = document.getElementById('history-list');
            hl.innerHTML = c.historial.length ? '' : '<p class="p-4 text-gray-400 italic text-sm">Sin historial.</p>';
            c.historial.forEach(h => {
                hl.innerHTML += `<li class="p-4 border-b border-gray-100 last:border-0"><div class="flex justify-between text-xs font-bold text-brand-green-dark"><span>${h.tipo}</span><span>${h.fecha}</span></div><p class="text-sm text-gray-700 mt-1">${h.detalle}</p></li>`;
            });

            // Vencimientos
            const vc = document.getElementById('vencimientos-container');
            vc.innerHTML = '';
            const campos = ['desinfeccion', 'seguro', 'vtv', 'filtro_comanry'];
            
            campos.forEach(k => {
                const v = c.vencimientos[k] || '';
                const st = verificarFecha(v);
                
                if(k === 'filtro_comanry') {
                    if(v) vc.innerHTML += `
                        <div class="p-3 bg-orange-50 rounded-lg border border-orange-100">
                            <label class="flex justify-between text-xs font-bold uppercase text-gray-500 mb-1"><span>Filtro Comanry</span><span class="${getTextClass(st.status)}">${st.message}</span></label>
                            <div class="flex gap-2"><input type="date" id="venc-${k}" value="${v}" class="flex-1 border rounded px-2 py-1 text-sm bg-white"><button onclick="handleGeneralUpdate(event)" class="bg-white px-2 rounded border hover:bg-gray-50"><i data-lucide="save" class="w-3 h-3"></i></button></div>
                        </div>`;
                    return;
                }
                
                vc.innerHTML += `<div><label class="flex justify-between text-xs font-bold uppercase text-gray-500 mb-1"><span>${k}</span><span class="${getTextClass(st.status)}">${st.message}</span></label>
                <div class="flex gap-2"><input type="date" id="venc-${k}" value="${v}" class="flex-1 border rounded px-2 py-1 text-sm"><button onclick="handleGeneralUpdate(event)" class="bg-gray-100 px-2 rounded border hover:bg-gray-200"><i data-lucide="save" class="w-3 h-3"></i></button></div></div>`;
            });

            const btnComanry = document.getElementById('add-filter-btn');
            btnComanry.className = c.vencimientos.filtro_comanry ? 'hidden' : 'mt-4 pt-4 border-t';
            
            const ss = verificarService(c);
            const lbl = document.getElementById('status-km-label');
            lbl.innerText = ss.message;
            lbl.className = getTextClass(ss.status);
            
            lucide.createIcons();
        }

        // --- HANDLERS ---
        async function handleNewUnit(e) {
            e.preventDefault();
            const maxId = FLOTA_DATA.length > 0 ? Math.max(...FLOTA_DATA.map(c => c.id)) : 0;
            const nc = {
                id: maxId + 1,
                patente: document.getElementById('new-patente').value.toUpperCase(),
                descripcion: document.getElementById('new-descripcion').value,
                km_actual: parseInt(document.getElementById('new-km').value),
                service: { ultimo_km: parseInt(document.getElementById('new-km').value), ultimo_fecha: "", intervalo_km: 10000 },
                vencimientos: { desinfeccion: "", seguro: "", vtv: "", filtro_comanry: "" },
                historial: [{ fecha: new Date().toISOString().split('T')[0], tipo: "Alta", detalle: "Unidad creada." }]
            };
            FLOTA_DATA.push(nc);
            if(await guardarEnServidor()) { closeNewUnitModal(); showDashboard(); alert("Unidad creada"); }
        }

        async function handleGeneralUpdate(e) {
            if(e) e.preventDefault();
            const c = FLOTA_DATA.find(x => x.id === selectedTruckId);
            c.patente = document.getElementById('input-patente').value;
            c.descripcion = document.getElementById('input-descripcion').value;
            const nk = parseInt(document.getElementById('input-km-actual').value);
            if(!isNaN(nk)) c.km_actual = nk;
            
            document.querySelectorAll('input[id^="venc-"]').forEach(i => c.vencimientos[i.id.replace('venc-','')] = i.value);
            
            await guardarEnServidor();
            alert("Guardado.");
            renderDetailView();
        }

        async function handleServiceUpdate(e) {
            e.preventDefault();
            const c = FLOTA_DATA.find(x => x.id === selectedTruckId);
            const f = document.getElementById('input-service-fecha').value;
            const k = parseInt(document.getElementById('input-service-km').value);
            
            if(k > c.km_actual) c.km_actual = k;
            c.service.ultimo_fecha = f;
            c.service.ultimo_km = k;
            c.historial.unshift({ fecha: f, tipo: 'Service', detalle: `Service a los ${formatNumber(k)} km.` });
            
            await guardarEnServidor();
            alert("Service registrado.");
            renderDetailView();
        }

        async function addFilterComanry() {
            const c = FLOTA_DATA.find(x => x.id === selectedTruckId);
            c.vencimientos.filtro_comanry = new Date().toISOString().split('T')[0];
            await guardarEnServidor();
            renderDetailView();
        }
        
        async function deleteTruck() {
            if(!confirm("¿Eliminar esta unidad?")) return;
            FLOTA_DATA = FLOTA_DATA.filter(c => c.id !== selectedTruckId);
            await guardarEnServidor();
            showDashboard();
        }

        function saveConfig() {
            CONFIG.diasAviso = parseInt(document.getElementById('config-dias').value);
            CONFIG.emailAlertas = document.getElementById('config-email').value;
            alert("Configuración guardada (Local)");
            showDashboard();
        }
    </script>
</body>
</html>